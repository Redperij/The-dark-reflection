# In this file is the core mechanics of the race conscipts for every country.





# This counts mountly recruit growth. Paradox, thanks (not) for the variable.
#
# mouthly_manpower_gain = 1000 * pop_growth * target_conscription_amount
#
# pop_growth - population growth for whole country
# target_conscription_amount - currently active conscription law in the state (Thanks PDX, at least something)
# 1000 - reverting number to represent every single recruit ( I know that it isn't precise but it really shouldn't be much ) # I'm just lazy :)

# Current mistakes:
# 1. Sometimes it goes over the actual manpower growth ( not much )
# 2. When conscription law is changed it is not affecting the country right away so we go over the actual growth for 2-3 months
# 3. Compliance isn't a thing, we count occupied states as simple cored states. ( not hard to fix, but it isn't a priority )

count_monthly_manpower_gain = {
	for_each_scope_loop = {
		array = global.countries

		set_variable = {
			var = THIS.monthly_manpower_growth
			value = max_manpower_k
		}

		if = { # If somebody, for some reason, decides to change pop growth base in a country then he must set a variable for that specific country.
			limit = {
				has_variable = pop_growth # MUST BE MULTYPLIED BY 1000 IN ADVANCE
			}
			multiply_variable = {
				var = monthly_manpower_growth
				value = pop_growth
			}
		}
		else = {
			multiply_variable = {
				var = monthly_manpower_growth
				value = 1.25 # Here is *1000 as well, base growth is 0.00125
			}
		}

		multiply_variable = {
			var = monthly_manpower_growth
			value = target_conscription_amount
		}

		round_variable = monthly_manpower_growth
	}
}

# Part of every race from total country manpower.
# Number to race in the array
# 0 pony
# 1 crystal_pony
# 2 earthpony
# 3 pegasi
# 4 unicorn
# 5 griffon
# 6 deer
# 7 thestral
# 8 dragon
# 9 bear
# 10 changeling
# 11 penguin
# 12 yak
# 13 dog
# 14 crystal_earthpony
# 15 crystal_pegasi
# 16 crystal_unicorn

count_race_part_in_country = {
	set_temp_variable = { effect_root = THIS }

	clear_array = effect_root:race_part
	resize_array = {
		array = effect_root:race_part # Holds all races race_manpower/total_manpower values
		size = 17
	}
	every_controlled_state = {
		limit = {
			OR = {
				is_in_array = { global.pony_states = THIS }
				is_in_array = { global.crystal_pony_states = THIS }
				is_in_array = { global.earthpony_states = THIS }
				is_in_array = { global.pegasi_states = THIS }
				is_in_array = { global.unicorn_states = THIS }
				is_in_array = { global.griffon_states = THIS }
				is_in_array = { global.deer_states = THIS }
				is_in_array = { global.thestral_states = THIS }
				is_in_array = { global.dragon_states = THIS }
				is_in_array = { global.bear_states = THIS }
				is_in_array = { global.changeling_states = THIS }
				is_in_array = { global.penguin_states = THIS }
				is_in_array = { global.yak_states = THIS }
				is_in_array = { global.dog_states = THIS }
				is_in_array = { global.crystal_earthpony_states = THIS }
				is_in_array = { global.crystal_pegasi_states = THIS }
				is_in_array = { global.crystal_unicorn_states = THIS }
			} 
		}
		if = {
			limit = {
				is_in_array = { global.pony_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 0
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.crystal_pony_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 1
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.earthpony_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 2
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.pegasi_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 3
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.unicorn_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 4
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.griffon_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 5
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.deer_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 6
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.thestral_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 7
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.dragon_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 8
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.bear_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 9
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.changeling_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 10
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.penguin_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 11
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.yak_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 12
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.dog_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 13
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.crystal_earthpony_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 14
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.crystal_pegasi_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 15
			}
		}
		else_if = {
			limit = {
				is_in_array = { global.crystal_unicorn_states = THIS }
			}
			set_temp_variable = {
				var = n
				value = 16
			}
		}

		add_to_variable = {
			var = effect_root:race_part^n
			value = state_population_k
		}
	}
	# Now we have an array race_part with all present races manpower in a country
	# Horrific division to get a part of the race in a country
	if = {
		limit = {
			NOT = {
				check_variable = {
					effect_root:max_manpower_k = 0 
				}
			}
		}
		for_loop_effect = {
			start = 0
			end = 17
			value = i

			divide_variable = {
				var = effect_root:race_part^i
				value = effect_root:max_manpower_k
			}
		}
	}
	#log = "[?effect_root:race_part^0|3] part ponies live in [Root.GetName]" #debug
}

# How many conscripts of each race will the country receive monthly
# Number to race in the array
# 0 pony
# 1 crystal_pony
# 2 earthpony
# 3 pegasi
# 4 unicorn
# 5 griffon
# 6 deer
# 7 thestral
# 8 dragon
# 9 bear
# 10 changeling
# 11 penguin
# 12 yak
# 13 dog
# 14 crystal_earthpony
# 15 crystal_pegasi
# 16 crystal_unicorn

get_montly_race_conscripts = {
	set_temp_variable = { effect_root = THIS }

	resize_array = {
		array = effect_root:race_conscripts # Holds all races conscripts in a country
		size = 17
	}
	for_loop_effect = {
		start = 0
		end = 17
		value = i

		set_temp_variable = {
			var = added_race_conscripts
			value = 0
		}

		add_to_temp_variable = {
			var = added_race_conscripts
			value = effect_root:race_part^i
		}
		multiply_temp_variable = {
			var = added_race_conscripts
			value = effect_root:monthly_manpower_growth
		}
		round_temp_variable = added_race_conscripts
		add_to_variable = {
			var = effect_root:race_conscripts^i
			value = added_race_conscripts
		}
	}

	#####################################################################################################
	# Funnier stuff ( laggy as fuck )                                                                   #
	# Pony race and Crystal pony race are just dummies to count actual recruits for their subdivisions  #
	# - earthponies, pegasi, unicorns and their crystal versions                                        #
	#####################################################################################################
	# Getting all pony recruits
	set_temp_variable = {
		var = conscripts_to_add
		value = effect_root:race_conscripts^0
	}
	# Getting random variable
	set_temp_variable = {
		var = random_division
		value = 1
	}
	randomize_temp_variable = {
		var = random_division
		distribution = uniform
		min = 2
		max = 4
	}
	#THIS = { #debug
	#	if = {
	#		limit = {
	#			original_tag = SEV
	#		}
	#		log = "[?conscripts_to_add|3] conscripts_to_add before first division in [Root.GetName]" #debug
	#	}
	#}
	# Dividing it using that temporary random variable
	divide_temp_variable = {
		var = conscripts_to_add
		value = random_division
	}
	#THIS = { #debug
	#	if = {
	#		limit = {
	#			original_tag = SEV
	#		}
	#		log = "[?conscripts_to_add|3] conscripts_to_add after first division in [Root.GetName]" #debug
	#	}
	#}
	# Rounding the result
	round_temp_variable = conscripts_to_add

	# It goes to the earthponies
	add_to_variable = {
		var = effect_root:race_conscripts^2
		value = conscripts_to_add
	}
	# ponies - taken_earthponies = ponies_left
	subtract_from_variable = {
		var = effect_root:race_conscripts^0
		value = conscripts_to_add
	}

	# Getting left ponies to distribute
	set_temp_variable = {
		var = conscripts_to_add
		value = effect_root:race_conscripts^0
	}
	# Different randomization method
	randomize_temp_variable = {
		var = random_division
		distribution = uniform
		min = 1.5
		max = 2.5
	}
	# Dividing it using that temporary random variable
	divide_temp_variable = {
		var = conscripts_to_add
		value = random_division
	}
	# Rounding the result
	round_temp_variable = conscripts_to_add

	# It goes to the pegasi
	add_to_variable = {
		var = effect_root:race_conscripts^3
		value = conscripts_to_add
	}
	# ponies - taken_pegasi = ponies_left
	subtract_from_variable = {
		var = effect_root:race_conscripts^0
		value = conscripts_to_add
	}

	# ponies_left = unicorns
	add_to_variable = {
		var = effect_root:race_conscripts^4
		value = effect_root:race_conscripts^0
	}
	# We don't have any ponies to distribute, so emptying the variable
	set_variable = {
		var = effect_root:race_conscripts^0
		value = 0
	}
	#######################################
	# Now the same for the crystal ponies #
	#######################################

	# Getting all crystal_pony recruits
	set_temp_variable = {
		var = conscripts_to_add
		value = effect_root:race_conscripts^1
	}
	# Getting random variable
	randomize_temp_variable = {
		var = random_division
		distribution = uniform
		min = 2
		max = 4
	}
	# Dividing it using that temporary random variable
	divide_temp_variable = {
		var = conscripts_to_add
		value = random_division
	}
	# Rounding the result
	round_temp_variable = conscripts_to_add

	# It goes to the crystal_earthponies
	add_to_variable = {
		var = effect_root:race_conscripts^14
		value = conscripts_to_add
	}
	# crystal_ponies - taken_crystal_earthponies = crystal_ponies_left
	subtract_from_variable = {
		var = effect_root:race_conscripts^1
		value = conscripts_to_add
	}

	# Getting left crystal_ponies to distribute
	set_temp_variable = {
		var = conscripts_to_add
		value = effect_root:race_conscripts^1
	}
	# Different randomization method
	randomize_temp_variable = {
		var = random_division
		distribution = uniform
		min = 1.5
		max = 2.5
	}
	# Dividing it using that temporary random variable
	divide_temp_variable = {
		var = conscripts_to_add
		value = random_division
	}
	# Rounding the result
	round_temp_variable = conscripts_to_add

	# It goes to the crystal_pegasi
	add_to_variable = {
		var = effect_root:race_conscripts^15
		value = conscripts_to_add
	}
	# crystal_ponies - taken_crystal_pegasi = crystal_ponies_left
	subtract_from_variable = {
		var = effect_root:race_conscripts^1
		value = conscripts_to_add
	}

	# crystal_ponies_left = crystal_unicorns
	add_to_variable = {
		var = effect_root:race_conscripts^16
		value = effect_root:race_conscripts^1
	}
	# We don't have any crystal_ponies to distribute, so emptying the variable
	set_variable = {
		var = effect_root:race_conscripts^1
		value = 0
	}

	#log = "[Root.GetTag] - ROOT and [This.GetTag] - THIS" #debug
	#log = "[?This.race_conscripts^0|0] recruits for pony race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^1|0] recruits for crystal_pony race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^2|0] recruits for earthpony race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^3|0] recruits for pegasi race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^4|0] recruits for unicorn race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^5|0] recruits for griffon race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^6|0] recruits for deer race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^7|0] recruits for thestral race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^8|0] recruits for dragon race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^9|0] recruits for bear race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^10|0] recruits for changeling race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^11|0] recruits for penguin race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^12|0] recruits for yak race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^13|0] recruits for dog race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^14|0] recruits for crystal_earthpony race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^15|0] recruits for crystal_pegasi race reporting for duty in [This.GetName]" #debug
	#log = "[?This.race_conscripts^16|0] recruits for crystal_unicorn race reporting for duty in [This.GetName]" #debug
}